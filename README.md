# 🤖 ShopBotJog

[![PyPI version](https://badge.fury.io/py/shopbotjog.svg)](https://badge.fury.io/py/shopbotjog)
[![Python 3.12+](https://img.shields.io/badge/python-3.12+-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

**Implementing rapid jog movements in Fusion 360 created ShopBot OpenSBP .sbp files**

## Overview

This toolset is designed to tweak the gcode generated by Fusion 360 Shopbot OpenSBP Post Processor.

If you look at the .spb code generated, you will see something that looks like this:

```text
' 1001 roughing pass
SA
CN, 90
IF %(25)=1 THEN GOTO UNIT_ERROR
&PWMaterial = 0.748
&PWZorigin = Part Surface
' When using Fusion for Personal Use, the feedrate of rapid
' moves is reduced to match the feedrate of cutting moves,
' which can increase machining time. Unrestricted rapid moves
' are available with a Fusion Subscription.

' Edges 1/4 flat
C7
&Tool = 1
C9
TR, 12000
C6
PAUSE 2
JZ, 0.5906
J2, 8.4865, 3.8624
MS, 3, 1
M3, 8.4865, 3.8624, 0.5906
M3, 8.4865, 3.8624, 0.1969
M3, 8.4865, 3.8624, 0.0394
M3, 8.4865, 3.8624, -0.475
.... and on for thousands of lines
```

Two things to notice.

1. The comment that "rapid moves" are not generated and are behind a paywall.. This really slows down cutting
2. The Fusion360 Shopbot OpenSBP Post Processor uses ONLY M3 commands for all router movement - both cutting moves and positioning moves above the material. The M3 command runs at cutting speed, which is slow that rapid positioning "Jog" commands. We would prefer to use J3 (jog) commands for rapid positioning moves above the surface since they run at much faster jog speed

The shopbot command reference <https://shopbottools.com/wp-content/uploads/2024/01/SBG00253150707CommandRefV3.pdf>
outlines what each of the commands does. Of special note are `M3` and `J3`:

```text
M3 - Move 3 Dimensions
{x-location/distance, y-location/distance, z-location/distance}
Makes an X, Y, and Z axis move to the designated location or a specified distance (if in Relative Mode) at
current Move or cutting speed. These 3-D interpolated moves are made on a diagonal from the current
location to the end location indicated in the location/distance values, which may be absolute or relative
depending on the Move Mode setting. If a value is not entered for one of the parameters, the value defaults
to the current location assuming a comma is used as a spacer to designate the correct parameter field.
```

```text
J3 - Jog 3 Dimensions
{x-location/distance, y-location/distance, z-location/distance}
Makes an X, Y, and Z axis move to the designated location or a specified distance (if in Relative Mode) at
current Jog speed. These 3-D interpolated moves are made on a diagonal from the current location to the
end location indicated in the location/distance values, which may be absolute or relative depending on the
Move Mode setting. If a value is not entered for one of the parameters, the value defaults to the current
location assuming a comma is used as a spacer to designate the correct parameter field.
```

A more efficient way to move would be to convert the Fusion 360 generated M3 commands that ae above the work surface to J3 commands. But how do we know which moves (M3) commands should be jogs (J3)?
In the example code above, we see that there is a `M3, 8.4865, 3.8624, 0.1969` where the Z height is `0.1969`. This matches exactly
the feed height that was specified in the Fusion tool path operation. These commands can be swapped from M3 to J3.

ShopBotJog analyzes your .sbp file by:

1. **Scanning** all M3 commands and collecting their Z-heights
2. **Finding** the most frequently used Z-height above zero (this is almost always the feed height from your Fusion toolpath)
3. **Confirming** with you that this detected height is correct
4. **Converting** all M3 commands at that feed height to faster J3 jog commands
5. **Backing up** your original file with a timestamp before making changes
6. **Adding** a header comment documenting what was changed and the detected feed height

## Similar Projects

- <https://github.com/thomergil/f360_fastcat> - works on standard gcode, not the shopbot .spb dialect. Handles file concatenation with tool changes which is nice, maybe a feature we can add at a later date.

## Installation

### From Source (Current)

ShopBotJog is not yet published to PyPI. For now, install from source:

Prequisite - install the uv python package manager <https://docs.astral.sh/uv/getting-started/installation/>

```bash
git clone https://github.com/peterb154/shopbot_jog.git
cd shopbot_jog
uv sync
```

Then run with:

```bash
uv run uv run shopbotjog path/to/your/file.sbp
```

### From PyPI (Future)

Once published, you'll be able to install with:

```bash
pip install shopbotjog
# or
uv add shopbotjog
```

## Usage

### Basic Usage

Analyze a file to see what ShopBotJog would do:

```bash
uv run shopbotjog path/to/your/file.sbp
```

In the example below, we analyze a file and determine that we can save almost 
six minutes on a very simple 3d contour.

```text
$ uv run shopbotjog artifacts/1001-bevel.sbp -a          
╭────────────────────────────────────────────────────────────╮
│ 🤖 ShopBotJog                                              │
│ Optimizing rapid jog movements in Fusion 360 ShopBot files │
╰────────────────────────────────────────────────────────────╯
🔍 Analyzing file: artifacts/1001-bevel.sbp
            📊 File Analysis             
┏━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━┓
┃ Metric            ┃ Value             ┃
┡━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━┩
│ Total Lines       │ 3436              │
│ M3 Commands Found │ 3328              │
│ Z Height Range    │ -0.7677 to 0.5906 │
└───────────────────┴───────────────────┘

            🎯 Positioning Heights Analysis             
┏━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━┓
┃ Height (inches) ┃ Occurrences ┃ Selection            ┃
┡━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━┩
│          0.1969 │          78 │ Feed Height (Target) │
│          0.5906 │           2 │ Positioning Move     │
│          0.0373 │           2 │ Positioning Move     │
│          0.0110 │           2 │ Positioning Move     │
└─────────────────┴─────────────┴──────────────────────┘

💡 Feed height selected as most frequent positioning move: 0.1969 (78 occurrences)

  🔄 Feed Height Optimization   
┏━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━┓
┃ Metric               ┃ Value ┃
┡━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━┩
│ Total M3 Commands    │ 3328  │
│ Feed Commands        │ 78    │
│ Cutting Commands     │ 3250  │
│ Commands to Optimize │ 2.3%  │
└──────────────────────┴───────┘

             ⚡ Feed Movement Time Savings             
┏━━━━━━━━━━━━━━━━━━━━━━┳━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┓
┃ Metric               ┃ Value                        ┃
┡━━━━━━━━━━━━━━━━━━━━━━╇━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━┩
│ Current Speed (M3)   │ 90.0 IPM (from MS command)   │
│ Jog Speed (J3)       │ 300.0 IPM (fallback default) │
│ Speed Improvement    │ 3.3x faster                  │
│ Estimated Time Saved │ 5.9 minutes                  │
└──────────────────────┴──────────────────────────────┘

📏 Calculated from 756.7 inches total distance, 9.8 inch average per move
📊 Analysis complete. Use without --analyze-only to process the file.
```

### Command Line Options

```text
$ uv run shopbotjog --help

Usage: shopbotjog [OPTIONS] INPUT_FILE

  ShopBotJog: Convert M3 commands to J3 at feed height for rapid ShopBot
  operation.

  Focuses on optimizing feed height movements for maximum speed improvement
  during positioning moves between cutting operations.

  INPUT_FILE: Path to the .sbp file to process

Options:
  -o, --output PATH      Custom output file path (default: modifies input file
                         in-place with backup)
  -y, --yes              Automatically confirm detected feed height
  -a, --analyze-only     Only analyze the file, don't modify it
  -q, --quiet            Suppress banner and verbose output
  --cutting-speed FLOAT  Fallback cutting speed in IPM for time calculations
                         if MS command not found (default: 60)
  --jog-speed FLOAT      Fallback jog speed in IPM for time calculations if JS
                         command not found (default: 300)
  --feed-height FLOAT    Manually specify feed height (primary optimization
                         target)
  --help                 Show this message and exit.
```

## Example .spb file Conversion

Before ShopBotJog:

```gcode
M3, 8.4865, 3.8624, 0.5906  ← Slow cutting speed at retract height
M3, 8.4865, 3.8624, -0.475  ← Cutting move (stays M3)
M3, 8.4865, 3.8624, 0.5906  ← Another slow retract move
```

After ShopBotJog:

```gcode
' File modified by ShopBotJog v0.1.0
' Feed height detected as: 0.5906
' M3 commands at feed height converted to J3 for rapid jogging
' Original file: your_file.sbp

J3, 8.4865, 3.8624, 0.5906  ← Now uses rapid jog speed! 🚀
M3, 8.4865, 3.8624, -0.475  ← Cutting move (unchanged)
J3, 8.4865, 3.8624, 0.5906  ← Another rapid jog move! 🚀
```

## Development

### Setup

```bash
git clone https://github.com/peterb154/shopbot_jog.git
cd shopbot_jog
make dev  # Install dev dependencies
```

### Development Commands

This project uses a Makefile for common development tasks:

```bash
make help       # Show available commands
make test       # Run tests with pytest
make lint       # Run all linting checks (ruff check, format check, mypy)
make lint-fix   # Fix all linting issues (ruff check --fix, format, mypy)
make typecheck  # Run mypy type checking only
make clean      # Clean up temporary files
```

### Manual Commands

If you prefer to run commands directly:

```bash
uv run pytest                    # Run tests
uv run pytest --cov=shopbotjog   # Run tests with coverage
uv run ruff check .              # Run linter
uv run ruff format .             # Format code
uv run mypy src/shopbotjog       # Type checking
```

## License

MIT License - see LICENSE file for details.

## Contributing

Issues and pull requests welcome! Please see the GitHub repository for more information.
