# üóΩ LibertyJog

[![PyPI version](https://badge.fury.io/py/libertyjog.svg)](https://badge.fury.io/py/libertyjog)
[![Python 3.12+](https://img.shields.io/badge/python-3.12+-blue.svg)](https://www.python.org/downloads/)
[![License: MIT](https://img.shields.io/badge/License-MIT-yellow.svg)](https://opensource.org/licenses/MIT)

**Liberating rapid jog movements from Fusion 360 ShopBot files**

## Overview

This toolset is designed to tweak the gcode generated by Fusion 360 Shopbot OpenSBP Post Processor.

If you look at the .spb code generated, you will see something that looks like this:

```text
' 1001 roughing pass
SA
CN, 90
IF %(25)=1 THEN GOTO UNIT_ERROR
&PWMaterial = 0.748
&PWZorigin = Part Surface
' When using Fusion for Personal Use, the feedrate of rapid
' moves is reduced to match the feedrate of cutting moves,
' which can increase machining time. Unrestricted rapid moves
' are available with a Fusion Subscription.

' Edges 1/4 flat
C7
&Tool = 1
C9
TR, 12000
C6
PAUSE 2
JZ, 0.5906
J2, 8.4865, 3.8624
MS, 3, 1
M3, 8.4865, 3.8624, 0.5906
M3, 8.4865, 3.8624, 0.1969
M3, 8.4865, 3.8624, 0.0394
M3, 8.4865, 3.8624, -0.475
.... and on for thousands of lines
```

Two things to notice.

1. The comment that "rapid moves" are not generated and are behind a paywall.. This really slows down cutting
2. Shopbot OpenSBP Post uses ONLY M3 commands to move the router head. Move is supposed to be used for cutting, but can also be used to move above the surface. We would prefer that we use Jog commands for moving above the surface more quickly

The shopbot command reference <https://shopbottools.com/wp-content/uploads/2024/01/SBG00253150707CommandRefV3.pdf>

outlines what each of the commands does. Of special note are `M3` and `J3`:

```text
M3 - Move 3 Dimensions
{x-location/distance, y-location/distance, z-location/distance}
Makes an X, Y, and Z axis move to the designated location or a specified distance (if in Relative Mode) at
current Move or cutting speed. These 3-D interpolated moves are made on a diagonal from the current
location to the end location indicated in the location/distance values, which may be absolute or relative
depending on the Move Mode setting. If a value is not entered for one of the parameters, the value defaults
to the current location assuming a comma is used as a spacer to designate the correct parameter field.
```

```text
J3 - Jog 3 Dimensions
{x-location/distance, y-location/distance, z-location/distance}
Makes an X, Y, and Z axis move to the designated location or a specified distance (if in Relative Mode) at
current Jog speed. These 3-D interpolated moves are made on a diagonal from the current location to the
end location indicated in the location/distance values, which may be absolute or relative depending on the
Move Mode setting. If a value is not entered for one of the parameters, the value defaults to the current
location assuming a comma is used as a spacer to designate the correct parameter field.
```

A more efficient way to move would be to convert the M3 commands to J3 commands. But how do we know which M3s should be jogs?
In the example code above, we see that there is a `M3, 8.4865, 3.8624, 0.1969` where the Z height is `0.1969`. This matches exactly
the feed height that was specified in the Fusion tool path operation. My theory is that these commands can be swapped from M3 to J3.

This program simply parses the .sbp file, looks for the Z value in all the M3 commands and determines which is the Z height. There should be lots of lines with that exact
Z value. This is almost certainly the feed height. Our script finds that height, confirms with the user that this is the feed height, then
edits the .sbp file changing M3 to J3 and adds a comment to the top of the file that it has been modified for speed by this program
and what we assumed to be the feed height. The original file is automatically backed up with a timestamp.

## Installation

```bash
pip install libertyjog
```

Or with uv:

```bash
uv add libertyjog
```

## Usage

### Basic Usage

Analyze a file to see what LibertyJog would do:

```bash
libertyjog path/to/your/file.sbp --analyze-only
```

Process a file (with confirmation):

```bash
libertyjog path/to/your/file.sbp
```

Process a file automatically (no confirmation):

```bash
libertyjog path/to/your/file.sbp --yes
```

### Advanced Usage

Manually specify feed height:

```bash
libertyjog path/to/your/file.sbp --feed-height 0.5906
```

Specify custom output file (no backup created):

```bash
libertyjog path/to/your/file.sbp --output optimized_file.sbp
```

Quiet mode (suppress banner and verbose output):

```bash
libertyjog path/to/your/file.sbp --quiet --yes
```

Configure speed settings for time calculations:

```bash
libertyjog path/to/your/file.sbp --cutting-speed 45 --jog-speed 350
```

### Command Line Options

- `--analyze-only`, `-a`: Only analyze the file, don't modify it
- `--feed-height FLOAT`: Manually specify feed height (skips auto-detection)
- `--yes`, `-y`: Automatically confirm detected feed height
- `--output PATH`, `-o`: Custom output file path (default: modifies input file in-place with backup)
- `--quiet`, `-q`: Suppress banner and verbose output
- `--cutting-speed FLOAT`: Fallback cutting speed in IPM for time calculations (default: 60)
- `--jog-speed FLOAT`: Fallback jog speed in IPM for time calculations (default: 300)

## How It Works

1. **Analysis**: LibertyJog scans your `.sbp` file for M3 commands and finds the highest Z-value that appears frequently
2. **Detection**: This most frequently used z height above 0.00 is almost certainly your feed height from Fusion 360
3. **Conversion**: All M3 commands at this feed height are converted to J3 (jog) commands
4. **Speed Boost**: Your ShopBot will now use rapid jog speed instead of cutting speed for these movements
5. **Backup**: Original file is automatically backed up with timestamp before modification

## Example Output

Before LibertyJog:

```gcode
M3, 8.4865, 3.8624, 0.5906  ‚Üê Slow cutting speed at retract height
M3, 8.4865, 3.8624, -0.475  ‚Üê Cutting move (stays M3)
M3, 8.4865, 3.8624, 0.5906  ‚Üê Another slow retract move
```

After LibertyJog:

```gcode
' File modified by LibertyJog v0.1.0
' Feed height detected as: 0.5906
' M3 commands at feed height converted to J3 for rapid jogging
' Original file: your_file.sbp

J3, 8.4865, 3.8624, 0.5906  ‚Üê Now uses rapid jog speed! üöÄ
M3, 8.4865, 3.8624, -0.475  ‚Üê Cutting move (unchanged)
J3, 8.4865, 3.8624, 0.5906  ‚Üê Another rapid jog move! üöÄ
```

## Development

### Setup

```bash
git clone https://github.com/peterb154/libertyjog.git
cd libertyjog
make dev  # Install dev dependencies
```

### Development Commands

This project uses a Makefile for common development tasks:

```bash
make help       # Show available commands
make test       # Run tests with pytest
make lint       # Run all linting checks (ruff check, format check, mypy)
make lint-fix   # Fix all linting issues (ruff check --fix, format, mypy)
make typecheck  # Run mypy type checking only
make clean      # Clean up temporary files
```

### Manual Commands

If you prefer to run commands directly:

```bash
uv run pytest                    # Run tests
uv run pytest --cov=libertyjog   # Run tests with coverage
uv run ruff check .              # Run linter
uv run ruff format .             # Format code
uv run mypy src/libertyjog       # Type checking
```

## License

MIT License - see LICENSE file for details.

## Contributing

Issues and pull requests welcome! Please see the GitHub repository for more information.
